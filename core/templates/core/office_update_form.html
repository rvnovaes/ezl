{% extends 'skeleton/forms/base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load querystring from django_tables2 %}
{% block head %}
    {{ block.super }}
    {% block css_head %}
        {{ block.super }}
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css"
              rel="stylesheet"/>
    {% endblock %}
{% endblock %}
{% block extra_form %}
    <div class="white-box">
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#endereco">Endereços</a></li>
            <li><a data-toggle="tab" href="#invite-users">Convites para usuários</a>
            </li>
        </ul>
        <div class="tab-content">
            <div id="endereco" class="tab-pane fade in active">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" paginate-fixed>
                        {% block table.thead %}
                            <thead>
                            <tr>
                                {% for column in table.columns %}
                                    {% if column.orderable %}
                                        <th {{ column.attrs.th.as_html }}><a
                                                href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|lower|capfirst }}</a>
                                        </th>
                                    {% else %}
                                        {% if not column.attrs.selectable == True %}
                                            <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                        {% else %}
                                            <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            </thead>
                        {% endblock table.thead %}
                        {% block table.tbody %}
                            <tbody>
                            {% for row in table.page.object_list|default:table.rows %}
                                {# support pagination #}
                                {% block table.tbody.row %}
                                    <tr class="{% cycle "odd" "even" %}"
                                        data-href="{{ row.attrs.data_href }}">
                                        {% for column, cell in row.items %}
                                            <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endblock table.tbody.row %}
                            {% empty %}
                                {% if table.empty_text %}
                                    {% block table.tbody.empty_text %}
                                        <tr>
                                            <td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td>
                                        </tr>
                                    {% endblock table.tbody.empty_text %}
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        {% endblock table.tbody %}
                        {% block table.tfoot %}
                            <tfoot></tfoot>
                        {% endblock table.tfoot %}
                    </table>
                </div>
                <div class="text-right" style="">
                    <button type="button" data-toggle="modal" data-target="#confirmeDelete" id="delete_buttom"
                            class="btn btn-fab btn-warning"><i class="fa fa-trash"></i></button>
                    <a class="btn btn-fab btn-success"
                       href="{% url 'address_office_create' object.pk %}">
                        <i class="fa fa-plus"></i></a>
                </div>
            </div>
            <div id="invite-users" class="tab-pane fade">
                <form class="form-inline editable-form" id="form-invite-user" action="#">
                    {% csrf_token %}
                    <input type="text" value="{{ object.pk }}" name="office" hidden>
                    <div class="control-group">
                        <div class="editable-input" style="width: 80%">
                            <input class="form-control input-sm twitter-typeahead" type="text"
                                   placeholder="Usuário a convidar..."
                                   style="padding-right: 24px;"
                                   id="person" data-url="/typeahead/search/inviteuser" name="person"
                                   value="" data-module="core.models" data-model="Person"
                                   search-field="legal_name">
                            <span class="editable-clear-x" style="display: none;"></span>
                        </div>
                        <div class="editable-buttons">
                            <button type="button" class="btn btn-success btn-sm editable-submit" id="btn-invite-user"><i
                                    class="glyphicon glyphicon-ok"> Convidar</i></button>
                        </div>
                    </div>
                </form>
                <div id="invite-table">

                </div>
            </div>
        </div>
    </div>
    {% include 'core/cpf_cnpj_mask.html' %}
{% endblock %}
{% block extra_scripts %}
    {% if view.model.use_upload %}
        <!-- UPLOADS SCRIPTS  -->
        {% include 'ecm/javascripts.html' %}

        <script src="{% static 'libs/jQuery-File-Upload/js/vendor/jquery.ui.widget.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.iframe-transport.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.fileupload.js' %}"></script>
        <script src="{% static 'skeleton/plugins/bower_components/jquery.tmpl/jquery.tmpl.js' %}"></script>
        <!-- DIV para o Ajax localizar o local (pelo ID) onde será incluído os novos scripts de deleção
             a medida que for adicionando novos arquivos -->
        <div id="scripts">
        </div>
    {% endif %}
    {{ inviteofficeform.media }}
    {#    Convite de usuario #}
    <script>
        $(document).ready(function () {
            var inviteTable = $("#invite-table");
            inviteTable.load('/convites/table', '#invite-table');
            $('#btn-invite-user').on('click', function (event) {
                var data = {};
                $('#invite-users').find('input').each(function () {
                    if ($(this).attr('name')) {
                        data[$(this).attr('name')] = $(this).attr('value')
                    }
                });
                console.debug(data);
                $.ajax({
                    type: 'POST',
                    url: '{% url 'invite_add' %}',
                    data: data,
                    success: function (result, status, xhr) {
                        inviteTable.load('/convites/table', '#invite-table');
                        $('.twitter-typeahead').typeahead('val', '');

                    },
                    error: function (request, status, error) {

                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    dataType: 'json'
                })
            })
        });
    </script>
{% endblock %}
