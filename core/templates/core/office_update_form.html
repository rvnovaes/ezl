{% extends 'skeleton/forms/base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load querystring from django_tables2 %}
{% load bootstrap3 %}
{% block head %}
    {{ block.super }}
    {% block css_head %}
        {{ block.super }}
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css"
              rel="stylesheet"/>
    {% endblock %}
    {% block extra_stylesheets %}
        <style>
            .btn.btn-outline.btn-success.btn-rounded {
                color: #53e69d;
                background-color: transparent !important;
            }

            .btn.btn-outline.btn-success.btn-rounded:hover {
                color: #fff;
                background-color: #53e69d !important;
            }

        </style>
    {% endblock %}
{% endblock %}

{% block extra_content %}
    <div class="white-box">
        <ul class="nav nav-tabs">
            <li class="active" id="li-endereco"><a data-toggle="tab" name="endereco" href="#endereco">Endereços</a></li>
            <li id="li-invite-users"><a data-toggle="tab" href="#invite-users">Convites para usuários</a></li>
            <li id="li-invite-offices"><a data-toggle="tab" href="#invite-offices">Convites para escritórios</a></li>
            <li id="li-invite-my-offices"><a data-toggle="tab" href="#my-invite-offices">Meus convites</a></li>
            <li id="li-office-users"><a data-toggle="tab" href="#office-users">Usuários Vinculados</a></li>
        </ul>
        <div class="tab-content">
            <div id="endereco" class="tab-pane fade in active">
                <form action="{% url 'address_office_delete' office_pk=object.pk %}" method="post" name="endereco"
                      id="addressForm">{% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" paginate-fixed>
                            {% block table.thead %}
                                <thead>
                                <tr>
                                    {% for column in table.columns %}
                                        {% if column.orderable %}
                                            <th {{ column.attrs.th.as_html }}><a
                                                    href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|lower|capfirst }}</a>
                                            </th>
                                        {% else %}
                                            {% if not column.attrs.selectable == True %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% else %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                </thead>
                            {% endblock table.thead %}
                            {% block table.tbody %}
                                <tbody>
                                {% for row in table.page.object_list|default:table.rows %}
                                    {% block table.tbody.row %}
                                        <tr class="{% cycle "odd" "even" %}"
                                            data-href="{{ row.attrs.data_href }}">
                                            {% for column, cell in row.items %}
                                                <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endblock table.tbody.row %}
                                {% empty %}
                                    {% if table.empty_text %}
                                        {% block table.tbody.empty_text %}
                                            <tr>
                                                <td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td>
                                            </tr>
                                        {% endblock table.tbody.empty_text %}
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            {% endblock table.tbody %}
                            {% block table.tfoot %}
                                <tfoot></tfoot>
                            {% endblock table.tfoot %}
                        </table>
                    </div>
                    <div class="text-right" style="">
                        <div class="text-right" style="">
                            <div class="fixed-btn">
                                <button type="button" id="delete_button" class="btn btn-danger"
                                        onclick="warningDelete(this)" disabled>Remover
                                </button>
                                <a class="btn btn-success" href="{% url 'address_office_create' object.pk %}">
                                    Adicionar</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="invite-users" class="tab-pane fade">
                <form class="form-inline editable-form" id="form-invite-user" action="#">
                    {% csrf_token %}
                    <input type="text" value="{{ object.pk }}" name="office" hidden>
                    <div class="control-group">
                        <div class="editable-input" style="width: 85%">
                            <input class="form-control input-sm twitter-typeahead" type="text"
                                   placeholder="Usuário a convidar..."
                                   style="padding-right: 24px; width: 100%"
                                   id="person" data-url="/typeahead/search/inviteuser" name="person"
                                   value="" data-module="core.models" data-model="Person"
                                   search-field="legal_name">
                            <span class="editable-clear-x" style="display: none;"></span>
                        </div>
                        <div class="editable-buttons">
                            <button type="button" class="btn btn-success btn-sm editable-submit"
                                    id="btn-invite-user"><i
                                    class="glyphicon glyphicon-ok"> Convidar</i></button>
                        </div>
                    </div>
                </form>
                <div id="invite-table">

                </div>
            </div>
            <div id="invite-offices" class="tab-pane fade">
                <form class="form-inline editable-form" id="form-invite-office" action="#">
                    {% csrf_token %}
                    <input type="text" value="{{ object.pk }}" name="office" hidden>
                    <div class="control-group">
                        <div class="editable-input" style="width: 85%">
                            <input class="form-control input-sm twitter-typeahead" type="text"
                                   placeholder="Usuário a convidar..."
                                   style="padding-right: 24px; width: 100%"
                                   id="office_invite" data-url="/typeahead/search/inviteoffice" name="office_invite"
                                   value="" data-module="core.models" data-model="Office"
                                   search-field="legal_name">
                            <span class="editable-clear-x" style="display: none;"></span>
                        </div>
                        <div class="editable-buttons">
                            <button type="button" class="btn btn-success btn-sm editable-submit"
                                    id="btn-invite-office"><i
                                    class="glyphicon glyphicon-ok"> Convidar</i></button>
                        </div>
                    </div>
                </form>
                <div id="invite-table-office">

                </div>
            </div>
            <div id="my-invite-offices" class="tab-pane fade">
                <div class="table-responsive">
                    {% if not object.invites_offices.all %}
                        <div class="alert alert-info alert-dismissable">
                            <p>
                                <i class="fa fa-1x fa-info-circle" aria-hidden="true"> </i>
                                <strong>Este escritório não possui nenhum convite pendente!</strong>
                            </p>
                        </div>
                    {% else %}
                        <table class="table table-striped table-hover" paginate-fixed>
                            <thead>
                            <tr>
                                <th>Escritório</th>
                                <th>CPF/CNPJ</th>
                                <th>Aceitar</th>
                                <th>Recusar</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for invite in object.invites_offices.all %}
                                {% if invite.status == 'N' %}
                                    <tr class="{% cycle 'odd' 'even' %}">
                                        <td>{{ invite.office.legal_name }}</td>
                                        <td>{{ invite.office.cpf_cnpj|default_if_none:'' }}</td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-outline btn-success btn-rounded"
                                                    onclick="updateInvite('{{ invite.pk }}', 'A', '{{ csrf_token }}', '/convites/invite_office_update/')">
                                                <i class="fa fa-thumbs-o-up"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-outline btn-danger btn-rounded"
                                                    onclick="updateInvite('{{ invite.pk }}', 'R', '{{ csrf_token }}', '/convites/invite_office_update/')">
                                                <i class="fa fa-thumbs-o-down"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
            <div id="office-users" class="tab-pane fade">
                <form action="{% url 'office_membership_inactive' office_pk=object.pk %}" method="post"
                      id="membersForm">{% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" paginate-fixed>
                            {% block table_members.thead %}
                                <thead>
                                <tr>
                                    {% for column in table_members.columns %}
                                        {% if column.orderable %}
                                            <th {{ column.attrs.th.as_html }}><a
                                                    href="{% querystring table_members.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|lower|capfirst }}</a>
                                            </th>
                                        {% else %}
                                            {% if not column.attrs.selectable == True %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% else %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                </thead>
                            {% endblock table_members.thead %}
                            {% block table_members.tbody %}
                                <tbody>
                                {% for row in table_members.page.object_list|default:table_members.rows %}
                                    {% block table_members.tbody.row %}
                                        <tr class="{% cycle "odd" "even" %}"
                                            data-href="{{ row.attrs.data_href }}">
                                            {% for column, cell in row.items %}
                                                <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endblock table_members.tbody.row %}
                                {% empty %}
                                    {% if table.empty_text %}
                                        {% block table_members.tbody.empty_text %}
                                            <tr>
                                                <td colspan="{{ table_members.columns|length }}">{{ table_members.empty_text }}</td>
                                            </tr>
                                        {% endblock table_members.tbody.empty_text %}
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            {% endblock table_members.tbody %}
                            {% block table_members.tfoot %}
                                <tfoot></tfoot>
                            {% endblock table_members.tfoot %}
                        </table>
                    </div>
                    <div class="pagination-fixed">
                        {% if table_members.page %}
                            {% block pagination %}
                                {% bootstrap_pagination table_members.page url=request.get_full_path %}
                            {% endblock pagination %}
                        {% endif %}
                    </div>
                    <div class="text-right" style="">
                        <div class="text-right" style="">
                            <div class="fixed-btn">
                                <button type="button" id="delete_button" class="btn btn-danger"
                                        onclick="warningDelete(this)" disabled>Desvincular
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% include 'core/mask_selector.html' %}
{% endblock %}
{% block extra_scripts %}
    {% if view.model.use_upload %}
        <!-- UPLOADS SCRIPTS  -->
        {% include 'ecm/javascripts.html' %}

        <script src="{% static 'libs/jQuery-File-Upload/js/vendor/jquery.ui.widget.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.iframe-transport.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.fileupload.js' %}"></script>
        <script src="{% static 'skeleton/plugins/bower_components/jquery.tmpl/jquery.tmpl.js' %}"></script>
        <!-- DIV para o Ajax localizar o local (pelo ID) onde será incluído os novos scripts de deleção
             a medida que for adicionando novos arquivos -->
        <div id="scripts">
        </div>
    {% endif %}
    {{ inviteofficeform.media }}
    {#    Convite de usuario #}
    <script>
        $(document).ready(function () {
            var invites = [
                {
                    btn: '#btn-invite-user',
                    url: '/convites/criar',
                    table_id: '#invite-table',
                    table_url: '/convites/table/',
                    el: '#invite-users'
                },
                {
                    btn: '#btn-invite-office',
                    url: '/convites/office/criar',
                    table_id: '#invite-table-office',
                    table_url: '/convites/office/table/',
                    el: '#invite-offices'
                }
            ];

            function isEmail(email) {
              var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
              return regex.test(email);
            }

            invites.forEach(function (invite) {
                var inviteTable = $(invite.table_id);
                inviteTable.load(invite.table_url + '{{ object.pk }}' + '/', invite.table_id);
                $(invite.btn).on('click', function (event) {
                    $('#inviting').modal('show');
                    var data = {};
                    $(invite.el).find('input').each(function () {
                        var person = $('#person');
                        if (person.attr('value') === "" && isEmail(person.val())){
                            person.attr('value', person.val())
                        }
                        if ($(this).attr('name')) {
                            data[$(this).attr('name')] = $(this).attr('value')
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: invite.url,
                        data: data,
                        success: function (result, status, xhr) {
                            if (result.error) {
                                showToast('error', 'Atenção', result.error, 0, false);
                            }
                            inviteTable.load(invite.table_url + '{{ object.pk }}' + '/', invite.table_id);
                            $(invite.el + ' .twitter-typeahead').typeahead('val', '');
                            $('#inviting').modal('hide');
                        },
                        error: function (request, status, error) {

                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                        },
                        dataType: 'json'
                    })
                });
            });
        });
    </script>

    <script language="JavaScript">
        // Warning Delete Message
        function warningDelete(source) {
            {% if on_delete == 'CASCADE' %}
                var text = "Ao excluir excluir o(s) registro(s) selecionado(s), todos os seus " +
                    "vínculos também serão excluídos! Essa ação é irreversível";
            {% else %}
                var text = "Tem certeza que deseja excluir o(s) registro(s) selecionado(s)? " +
                    "Essa ação é irreversível.";
            {% endif %}
            var action = "Excluir";
            if (source.form.id == 'membersForm') {
                text = "Tem certeza que deseja desvincular as pessoas selecionadas deste escritório? ";
                action = "Desvincular"
            }

            swal({
                title: action + "?",
                text: text,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Sim, Desejo " + action.toLowerCase() + "!",
                closeOnConfirm: false,
                cancelButtonText: "Cancelar."
            }, function () {
                $('#' + source.form.id).submit()
            });
        }

        var pk_list = [];

        function toggle(source) {
            checkboxes = document.getElementsByName('selection');
            for (var i in checkboxes) {

                if (checkboxes.hasOwnProperty(i)) {
                    checkboxes[i].checked = source.checked;
                    if (source.checked)
                        pk_list.push(checkboxes[i].id);
                    else
                        pk_list = []
                }
            }
            if (pk_list.length > 0) {
                $("#" + source.form.id + " #delete_button").attr('disabled', false);
            } else {
                $("#" + source.form.id + " #delete_button").attr('disabled', true);
            }
        }

        function showDeleteButton(source) {
            if (source.checked) {
                pk_list.push(source.id);
            } else {
                pk_list.pop();
                $("#" + source.form.id + " #selection_header").attr('checked', false);
            }

            if (pk_list.length > 0)
                $("#" + source.form.id + " #delete_button").attr('disabled', false);
            else
                $("#" + source.form.id + " #delete_button").attr('disabled', true);
        }
    </script>
    <script>
        $(document).ready(function () {
            $('.nav.nav-tabs').find('li').each(function () {
                $(this).on('click', function () {
                    window.sessionStorage.setItem('active-tab', $(this).attr('id'));
                })
            });
            var ulEl = $('#' + window.sessionStorage.getItem('active-tab'));
            if (ulEl){
                ulEl.find('a').each(function () {
                    $(".nav-tabs a[href='" + $(this).attr('href') + "']").tab('show');
                })
            } else {
                $(".nav-tabs a[href=#endereco]").tab('show');
            }

        })


    </script>
{% endblock %}
{% block extra_modal %}
    <!-- Janela modal para mostrar progresso de deleção do arquivo -->
    <div id="inviting" class="modal">
        <div class="modal-dialog modal-sm">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center;">
                    <h1>Aguarde...</h1>
                    <p class="h1"><i class="fa fa-spin fa-circle-o-notch"></i></p>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
{% endblock extra_modal %}
