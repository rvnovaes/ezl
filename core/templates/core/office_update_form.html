{% extends 'skeleton/forms/base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load querystring from django_tables2 %}
{% block head %}
    {{ block.super }}
    {% block css_head %}
        {{ block.super }}
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css"
              rel="stylesheet"/>
    {% endblock %}
    {% block extra_stylesheets %}
        <style>
            .btn.btn-outline.btn-success.btn-rounded {
                color: #53e69d;
                background-color: transparent !important;
            }

            .btn.btn-outline.btn-success.btn-rounded:hover {
                color: #fff;
                background-color: #53e69d !important;
            }

        </style>
    {% endblock %}
{% endblock %}

{% block extra_content %}
    <div class="white-box">
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#endereco">Endereços</a></li>
            <li><a data-toggle="tab" href="#invite-users">Convites para usuários</a></li>
            <li><a data-toggle="tab" href="#invite-offices">Convites para escritórios</a></li>
            <li><a data-toggle="tab" href="#my-invite-offices">Meus convites</a></li>
        </ul>
        <div class="tab-content">
            <div id="endereco" class="tab-pane fade in active">
                <form action="{% url 'address_office_delete' office_pk=object.pk %}" method="post"
                      id="addressForm">{% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" paginate-fixed>
                            {% block table.thead %}
                                <thead>
                                <tr>
                                    {% for column in table.columns %}
                                        {% if column.orderable %}
                                            <th {{ column.attrs.th.as_html }}><a
                                                    href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|lower|capfirst }}</a>
                                            </th>
                                        {% else %}
                                            {% if not column.attrs.selectable == True %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% else %}
                                                <th {{ column.attrs.th.as_html }}>{{ column.header }}</th>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                </thead>
                            {% endblock table.thead %}
                            {% block table.tbody %}
                                <tbody>
                                {% for row in table.page.object_list|default:table.rows %}
                                    {% block table.tbody.row %}
                                        <tr class="{% cycle "odd" "even" %}"
                                            data-href="{{ row.attrs.data_href }}">
                                            {% for column, cell in row.items %}
                                                <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endblock table.tbody.row %}
                                {% empty %}
                                    {% if table.empty_text %}
                                        {% block table.tbody.empty_text %}
                                            <tr>
                                                <td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td>
                                            </tr>
                                        {% endblock table.tbody.empty_text %}
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            {% endblock table.tbody %}
                            {% block table.tfoot %}
                                <tfoot></tfoot>
                            {% endblock table.tfoot %}
                        </table>
                    </div>
                    <div class="text-right" style="">
                        <div class="text-right" style="">
                            <div class="fixed-btn">
                                <button type="button" id="delete_button" class="btn btn-danger" disabled>Remover
                                </button>
                                <a class="btn btn-success" href="{% url 'address_office_create' object.pk %}">
                                    Adicionar</a>
                            </div>
                        </div>
                    </div>
                    <!-- Modal -->
                    <div id="confirmDelete" class="modal">
                        <div class="modal-dialog">
                            <div class="modal-content ">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                                    </button>
                                    <h4 class="modal-title"><i class="fa fa-trash"></i></h4>
                                    <h4 class="modal-title">Atenção!</h4>
                                </div>
                                <div class="modal-body">
                                    {% if on_delete == 'CASCADE' %}
                                        <p>Ao excluir excluir o(s) registro(s) selecionado(s), todos os seus
                                            vínculos também
                                            serão excluídos! Essa ação é irreversível. Deseja continuar?</p>
                                    {% else %}
                                        <p>Tem certeza que deseja excluir o(s) registro(s) selecionado(s)? Essa ação
                                            é
                                            irreversível.
                                            Deseja continuar?</p>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">Sim</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="invite-users" class="tab-pane fade">
                <form class="form-inline editable-form" id="form-invite-user" action="#">
                    {% csrf_token %}
                    <input type="text" value="{{ object.pk }}" name="office" hidden>
                    <div class="control-group">
                        <div class="editable-input" style="width: 85%">
                            <input class="form-control input-sm twitter-typeahead" type="text"
                                   placeholder="Usuário a convidar..."
                                   style="padding-right: 24px; width: 100%"
                                   id="person" data-url="/typeahead/search/inviteuser" name="person"
                                   value="" data-module="core.models" data-model="Person"
                                   search-field="legal_name">
                            <span class="editable-clear-x" style="display: none;"></span>
                        </div>
                        <div class="editable-buttons">
                            <button type="button" class="btn btn-success btn-sm editable-submit"
                                    id="btn-invite-user"><i
                                    class="glyphicon glyphicon-ok"> Convidar</i></button>
                        </div>
                    </div>
                </form>
                <div id="invite-table">

                </div>
            </div>
            <div id="invite-offices" class="tab-pane fade">
                <form class="form-inline editable-form" id="form-invite-office" action="#">
                    {% csrf_token %}
                    <input type="text" value="{{ object.pk }}" name="office" hidden>
                    <div class="control-group">
                        <div class="editable-input" style="width: 85%">
                            <input class="form-control input-sm twitter-typeahead" type="text"
                                   placeholder="Usuário a convidar..."
                                   style="padding-right: 24px; width: 100%"
                                   id="office_invite" data-url="/typeahead/search/inviteoffice" name="office_invite"
                                   value="" data-module="core.models" data-model="Office"
                                   search-field="legal_name">
                            <span class="editable-clear-x" style="display: none;"></span>
                        </div>
                        <div class="editable-buttons">
                            <button type="button" class="btn btn-success btn-sm editable-submit"
                                    id="btn-invite-office"><i
                                    class="glyphicon glyphicon-ok"> Convidar</i></button>
                        </div>
                    </div>
                </form>
                <div id="invite-table-office">

                </div>
            </div>
            <div id="my-invite-offices" class="tab-pane fade">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" paginate-fixed>
                        <thead>
                        <tr>
                            <th>Escritório</th>
                            <th>CPF/CNPJ</th>
                            <th>Aceitar</th>
                            <th>Recusar</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for invite in object.invites_offices.all %}
                            {% if invite.status == 'N' %}
                                <tr class="{% cycle 'odd' 'even' %}">
                                    <td>{{ invite.office.legal_name }}</td>
                                    <td>{{ invite.office.cpf_cnpj|default_if_none:'' }}</td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-outline btn-success btn-rounded"
                                                onclick="updateInvite('{{ invite.pk }}', 'A', '{{ csrf_token }}', '/convites/invite_office_update/')">
                                            <i class="fa fa-thumbs-o-up"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-outline btn-danger btn-rounded"
                                                onclick="updateInvite('{{ invite.pk }}', 'R', '{{ csrf_token }}', '/convites/invite_office_update/')">
                                            <i class="fa fa-thumbs-o-down"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% include 'core/mask_selector.html' %}
{% endblock %}
{% block extra_scripts %}
    {% if view.model.use_upload %}
        <!-- UPLOADS SCRIPTS  -->
        {% include 'ecm/javascripts.html' %}

        <script src="{% static 'libs/jQuery-File-Upload/js/vendor/jquery.ui.widget.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.iframe-transport.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.fileupload.js' %}"></script>
        <script src="{% static 'skeleton/plugins/bower_components/jquery.tmpl/jquery.tmpl.js' %}"></script>
        <!-- DIV para o Ajax localizar o local (pelo ID) onde será incluído os novos scripts de deleção
             a medida que for adicionando novos arquivos -->
        <div id="scripts">
        </div>
    {% endif %}
    {{ inviteofficeform.media }}
    {#    Convite de usuario #}
    <script>
        $(document).ready(function () {
            var invites = [
                {
                    btn: '#btn-invite-user',
                    url: '/convites/criar',
                    table_id: '#invite-table',
                    table_url: '/convites/table/',
                    el: '#invite-users'
                },
                {
                    btn: '#btn-invite-office',
                    url: '/convites/office/criar',
                    table_id: '#invite-table-office',
                    table_url: '/convites/office/table/',
                    el: '#invite-offices'
                }
            ];

            invites.forEach(function (invite) {
                var inviteTable = $(invite.table_id);
                inviteTable.load(invite.table_url + '{{ object.pk }}' + '/', invite.table_id);
                $(invite.btn).on('click', function (event) {
                    var data = {};
                    $(invite.el).find('input').each(function () {
                        if ($(this).attr('name')) {
                            data[$(this).attr('name')] = $(this).attr('value')
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: invite.url,
                        data: data,
                        success: function (result, status, xhr) {
                            inviteTable.load(invite.table_url + '{{ object.pk }}' + '/', invite.table_id);
                            $(invite.el + ' .twitter-typeahead').typeahead('val', '');

                        },
                        error: function (request, status, error) {

                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                        },
                        dataType: 'json'
                    })
                });
            });
        });
    </script>

    <script language="JavaScript">
        // Warning Delete Message
        $('#delete_button').click(function () {
            {% if on_delete == 'CASCADE' %}
                var text = "Ao excluir excluir o(s) registro(s) selecionado(s), todos os seus " +
                    "vínculos também serão excluídos! Essa ação é irreversível";
            {% else %}
                var text = "Tem certeza que deseja excluir o(s) registro(s) selecionado(s)? " +
                    "Essa ação é irreversível.";
            {% endif %}

            swal({
                title: "Excluir?",
                text: text,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Sim, Desejo excluir!",
                closeOnConfirm: false,
                cancelButtonText: "Cancelar."
            }, function () {
                $('#addressForm').submit()
            });
        });

        var pk_list = [];

        function toggle(source) {
            checkboxes = document.getElementsByName('selection');
            for (var i in checkboxes) {

                if (checkboxes.hasOwnProperty(i)) {
                    checkboxes[i].checked = source.checked;
                    if (source.checked)
                        pk_list.push(checkboxes[i].id);
                    else
                        pk_list = []
                }
            }
            if (pk_list.length > 0) {
                document.getElementById('delete_button').disabled = false;
            } else {
                document.getElementById('delete_button').disabled = true;
            }
        }

        function showDeleteButton(source) {
            if (source.checked) {
                pk_list.push(source.id);
            } else {
                pk_list.pop();
                document.getElementById("selection_header").checked = false;
            }

            if (pk_list.length > 0)
                document.getElementById('delete_button').disabled = false;
            else
                document.getElementById('delete_button').disabled = true;

        }
    </script>
{% endblock %}
