{% extends 'skeleton/base.html' %}
{% load static %}
{% block sidebar %}
{% endblock %}
{% block extra_stylesheets %}
    <!-- Wizard CSS -->
    <link href="{% static 'skeleton/plugins/bower_components/jquery-wizard-master/css/wizard.css' %}" rel="stylesheet">
    <!-- color CSS -->
    <link href="{% static 'skeleton/css/colors/default.css' %}" id="theme" rel="stylesheet">

    <link href="{% static 'libs/toastr/build/toastr.min.css' %}" rel="stylesheet">

    <link href="{% static 'skeleton/plugins/bower_components/custom-select/custom-select.css' %}" rel="stylesheet" type="text/css">
    <style>
        #page-wrapper{
            margin-left: 0!important;
        }
        .modal-title{
            margin-top: 15px !important;
        }
        div.select-row-icon{padding:0;margin:0}
        div.select-row-icon div{display:block;list-style:none}
        div.select-row-icon div a{display:block;color:#313131;padding:8px 15px;position:relative;border:2px solid #fff}
        div.select-row-icon div a i{font-size:24px;vertical-align:middle;padding-right:10px}
        div.select-row-icon div a i.whn-hov{color:#41b3f9;display:none;float:right;position:absolute;right:15px;top:10px}
        div.select-row-icon div a.selected,div.select-row-icon div a:hover{border:2px solid rgba(120,130,140,.13)}
        div.select-row-icon div a.selected i.whn-hov,div.select-row-icon div a:hover i.whn-hov{display:inline-block}
    </style>
{% endblock %}
{% block navbar %}
    <nav class="navbar navbar-default navbar-static-top m-b-0">
        <div class="col-md-12 text-center m-t-15 m-b-10">
            <p>Já possui uma conta? <a href="{% url 'login' %}" class="text-primary m-l-5"><b>Entrar</b></a>
            </p>
        </div>
    </nav>
{% endblock %}
{% block containner %}
    <!-- .row -->
    <div class="row">
        <div class="col-sm-12">
            <div class="white-box">
                <h3 class="box-title m-b-0">CADASTRE-SE AGORA</h3>
                <p class="text-muted m-b-30 font-13">Crie sua conta para começar a trabalhar</p>
                <div id="registerForm" class="wizard">
                    <ul class="wizard-steps" role="tablist">
                        <li class="active" role="tab">
                            <h4><span><i class="ti-user"></i></span>Dados de Acesso</h4> </li>
                        <li role="tab">
                            <h4><span><i class="fa fa-building-o"></i></span>Forma de trabalho</h4> </li>
                        <li role="tab">
                            <h4><span><i class="ti-check"></i></span>Confirmar</h4> </li>
                    </ul>
                    <form id="validation" class="form-horizontal">
                        {% csrf_token %}
                        <div class="wizard-content">
                            <div class="wizard-pane active" role="tabpanel">
                                <div class="form-group">
                                    <label class="col-xs-3 control-label">Nome</label>
                                    <div class="col-xs-5">
                                        <input type="text" class="form-control" name="name" /> </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-3 control-label">Usuário</label>
                                    <div class="col-xs-5">
                                        <input type="text" class="form-control" name="username" /> </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-3 control-label">E-mail</label>
                                    <div class="col-xs-5">
                                        <input type="text" class="form-control" name="email" /> </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-3 control-label">Senha</label>
                                    <div class="col-xs-5">
                                        <input type="password" class="form-control" name="password" /> </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-xs-3 control-label">Confirmar Senha</label>
                                    <div class="col-xs-5">
                                        <input type="password" class="form-control" name="confirmpassword" /> </div>
                                </div>
                            </div>
                            <div class="wizard-pane" role="tabpanel">
                                <div class="form-group">
                                    <div class="input-group">
                                    </div>
                                    <input type="hidden" name="select_office_register" required>
                                    <div id="select_office_register" class="select-row-icon">
                                        <div class="row col-md-12">
                                            <a id="existing_office" data-id="1" class='select_office_list' href="javascript:void(0)"><i class="mdi mdi-credit-card"></i> <span>Vincular-me a um escritório já cadastrado</span> <i class="whn-hov mdi mdi-checkbox-marked-circle"></i></a>
                                            <div id="select_office_detail_1" class="hide b-all p-10 m-b-15 text-center">
                                                <h5 class="modal-title">Selecione o Escritório</h5>
                                                <div class="row m-t-10 m-b-10">
                                                    <div class="col-md-12"><input type="text" class="form-control form-inline" autocomplete="off" data-session="false" placeholder="Procurar..." id="filter_office_legal_name" name="filter_office_legal_name" ></div>
                                                </div>
                                                <div class="row" style="max-height: 400px; min-height: 140px; overflow: scroll">
                                                    {% for office in offices %}
                                                        <div class="col-md-4 col-sm-12 hide" id="office-{{ office.id }}">
                                                            <div class="white-box color-bordered-table muted-bordered-table p-10 office-card-p" onclick="select_office('{{office.pk}}')">
                                                                <div class="row">
                                                                    <div class="col-md-2 col-sm-2 text-center">
                                                                        <button type="button" class="btn btn-default btn-circle btn-md">
                                                                            <i class="fa fa-building-o"></i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="col-md-10 col-sm-10" style="overflow-y: auto; overflow-x:hidden;">
                                                                        <span class="box-title office-legal-name"><small>{{office.legal_name}}</small></span>
                                                                        {% with office.get_address.first as first_address  %}
                                                                            {% if first_address %}
                                                                                <br /><small><strong>{{ first_address.city.name }} ({{ first_address.city.state.initials }})</strong></small>
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                        <input type="checkbox" name="office_checkbox_{{ office.pk }}" class="hidden" value="{{ office.pk }}" >
                                                                    </div>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-md-12 office-select-button">
                                                                        <button id="button_action-{{ office.pk }}"
                                                                                class="btn btn-custom btn-block btn-rounded btn-block m-t-10 p-t-0 p-b-0">
                                                                            <i id='icon-{{ office.pk }}' class="fa fa-check" style="font-size: 13px;"></i>
                                                                            <span id="title-{{ office.pk }}" style="font-size: 12px;">Selecionar</span></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row col-md-12">
                                            <a id="new_office" data-id="2" class='select_office_list' href="javascript:void(0)"><i class="mdi mdi-monitor"></i> <span> Não encontrei meu escritório e desejo cadastrá-lo</span> <i class="whn-hov mdi mdi-checkbox-marked-circle"></i></a>
                                            <div id="select_office_detail_2" class="hide b-all p-20 m-b-15 text-center">
                                                <div class="form-group">
                                                    <label class="col-xs-3 control-label">Razão social / Nome complete</label>
                                                    <div class="col-xs-5">
                                                        <input type="text" class="form-control" name="legal_name" /> </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-3 control-label">Nome fantasia / Apelido</label>
                                                    <div class="col-xs-5">
                                                        <input type="text" class="form-control" name="office_name" /> </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-3 control-label">Tipo</label>
                                                    <div class="col-xs-5">
                                                        <select name="legal_type" class="form-control" title="" id="id_legal_type">
                                                          <option value="F">Física</option>
                                                          <option value="J" selected="">Jurídica</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-3 control-label">CPF / CNPJ</label>
                                                    <div class="col-xs-5">
                                                        <input type="text" class="form-control" name="cpf_cnpj" id="id_cpf_cnpj" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row col-md-12">
                                            <a id="work_alone" data-id="3" class='select_office_list' href="javascript:void(0)"><i class="mdi mdi-cash"></i> <span>Trabalho sozinho</span> <i class="whn-hov mdi mdi-checkbox-marked-circle"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="wizard-pane" role="tabpanel">

                            </div>
                        </div>
                        {% include 'core/mask_selector.html' %}
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- /.row -->
{% endblock containner %}
{% block modal %}
{% endblock %}
{% block extra_scripts %}
    <!-- Form Wizard JavaScript -->
    <script src="{% static 'skeleton/plugins/bower_components/jquery-wizard-master/dist/jquery-wizard.min.js' %}"></script>
    <!-- FormValidation -->
    <link rel="stylesheet" href="{% static 'skeleton/plugins/bower_components/jquery-wizard-master/libs/formvalidation/formValidation.min.css' %}">
    <!-- FormValidation plugin and the class supports validating Bootstrap form -->
    <script src="{% static 'skeleton/plugins/bower_components/jquery-wizard-master/libs/formvalidation/formValidation.min.js' %}"></script>
    <script src="{% static 'skeleton/plugins/bower_components/jquery-wizard-master/libs/formvalidation/bootstrap.min.js' %}"></script>
    <!--Toast-->
    <script src="{% static 'libs/toastr/build/toastr.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'skeleton/plugins/bower_components/custom-select/custom-select.min.js' %}"></script>

    <script type="text/javascript">
    (function() {
        $('#registerForm').wizard({
            buttonLabels: {
                next: 'Próximo',
                back: 'Anterior',
                finish: 'Finalizar'
            },
            onInit: function() {
                $('#validation').formValidation({
                    framework: 'bootstrap',
                    fields: {
                        name: {
                            validators: {
                                notEmpty: {
                                    message: 'O campo de nome é obrigatório'
                                }
                            }
                        },
                        username: {
                            validators: {
                                notEmpty: {
                                    message: 'O nome de usuário é obrigatório'
                                },
                            }
                        },
                        email: {
                            validators: {
                                notEmpty: {
                                    message: 'O e-mail é obrigatório'
                                },
                                emailAddress: {
                                    message: 'O valor inserido não é um endereço de e-mail válido'
                                }
                            }
                        },
                        password: {
                            threshold: 8,
                            validators: {
                                notEmpty: {
                                    message: 'É obrigatório uma senha de acesso'
                                },
                                different: {
                                    field: 'username',
                                    message: 'A senha não pode ser a mesma do usuário'
                                },
                                remote: {
                                    message: 'A senha não atende aos requisitos',
                                    url: '/validate_password/',
                                    type: 'POST',
                                    data: function(validator, $field, value) {
                                        return {
                                            csrfmiddlewaretoken: validator.getFieldElements('csrfmiddlewaretoken').val()
                                        };
                                    }
                                }
                            }
                        },
                        confirmpassword: {
                            validators: {
                                identical: {
                                    field: 'password',
                                    message: 'Os valores digitados para os campos de senha não conferem'
                                }
                            }
                        },
                        legal_name: {
                            validators: {
                                callback: {
                                    message: 'Este campo é obrigatório',
                                    callback: function (value, validator, $field) {
                                        var select_office_register = $('input[name=select_office_register]').val();
                                        if (select_office_register === '2'){
                                            return value !== '';
                                        }else{
                                            return true;
                                        }
                                    }
                                },
                            }
                        },
                        filter_office_legal_name: {
                            validators: {
                                callback: {
                                    message: "Favor selecionar pelo menos um escritório para se vincular",
                                    callback: function (value, validator, $field) {
                                        var select_office_register = $('input[name=select_office_register]').val();
                                        if (select_office_register === '1'){
                                            retorno = false
                                            $('input[name^=office_checkbox_]').each(function (index) {
                                                if ($( this ).prop("checked")){
                                                    retorno = true;
                                                }
                                            });
                                            console.log(retorno)
                                            return retorno;
                                        }else{
                                            return true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            },
            validator: function() {
                var fv = $('#validation').data('formValidation');
                var $this = $(this);
                // Validate the container
                fv.validateContainer($this);
                var isValidStep = fv.isValidContainer($this);
                if (isValidStep === false || isValidStep === null) {
                    return false;
                }
                return true;
            },
            onFinish: function() {
                $('#validation').submit();
                swal("Message Finish!", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed lorem erat eleifend ex semper, lobortis purus sed.");
            }
        });
    })();
    </script>
    <script>
        $("#select_office_register div a").on('click', function () {
            $('.select_office_list').removeClass("selected");
            $(this).addClass("selected");
            $('input[name=select_office_register]').val($(this).data('id'));
            $('div[id^="select_office_detail_"]').addClass("hide");
            $("#select_office_detail_"+$(this).data('id')).removeClass("hide");
        });
    </script>
    <script>
        function select_office(office_id) {
            var office_input = $('input[name=office_checkbox_'+office_id+']');
            var office_icon = $('#icon-'+office_id);
            var office_title = $('#title-'+office_id);
            var button_action = $('#button_action-'+office_id);
            var office_card = $('#office-'+office_id);
            office_input.trigger('click')

            if (office_input.prop("checked")){
                office_icon.removeClass('fa-check')
                office_icon.addClass('fa-times')
                office_title.html(' Remover')
                button_action.removeClass('btn-custom')
                button_action.addClass('btn-danger')
                office_card.addClass('card-fixed')
            }else{
                office_icon.removeClass('fa-times')
                office_icon.addClass('fa-check')
                office_title.html(' Selecionar')
                button_action.removeClass('btn-danger')
                button_action.addClass('btn-custom')
                office_card.removeClass('card-fixed')
            }
            $('#validation').formValidation('revalidateField', 'filter_office_legal_name')
        }
    </script>
{% endblock extra_scripts %}
{% block script_document_ready %}
    {% if form.errors %}
        {% for field in form %}
            {% for error in field.errors %}
                toastr.error('{{ error }}', 'Erro ao efetuar o login', {timeOut: 5000});
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            toastr.error('{{ error }}', 'Erro ao efetuar o login', {timeOut: 5000});
        {% endfor %}
    {% endif %}
    $('.select2').select2();
    $('input[name^=office_checkbox_]').each(function (index) {
        if($( this ).prop("checked")){
            var office_id = $( this ).val();
            var office_card = $('#office-'+office_id);
            var office_icon = $('#icon-'+office_id);
            var office_title = $('#title-'+office_id);
            var button_action = $('#button_action-'+office_id);
            office_icon.removeClass('fa-check')
            office_icon.addClass('fa-times')
            office_title.html(' Remover')
            button_action.removeClass('btn-custom')
            button_action.addClass('btn-danger')
            office_card.addClass('card-fixed')
            office_card.removeClass('hide')
        }
    })
    $( "input[name=password]" ).blur(function() {
      $('#validation').formValidation('revalidateField', 'password')
    });
{% endblock %}
