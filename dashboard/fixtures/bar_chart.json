[
{
    "model": "dashboard.barchart",
    "pk": 1,
    "fields": {
        "name": "Top 10 combina\u00e7\u00e3o advogado e preposto",
        "code": "from lawsuit.models import Folder\r\nfrom task.models import Task\r\nfrom django.db.models import Max, Subquery, OuterRef, Count, Q\r\nfrom django.db.models.functions import Coalesce\r\n\r\nfolders = Folder.objects.filter(person_customer__company_id=self.context.get('request').GET.get('company_id'))\r\noffice_corresp = Task.objects.filter(id=OuterRef('child')).order_by('-id')\r\ntasks = Task.objects.filter(\r\n  \t\tmovement__folder__in=folders,\r\n  \t\tperson_company_representative__isnull=False\r\n    ).annotate(\r\n        filho=Max('child')\r\n    ).annotate(\r\n        office_exec=Subquery(office_corresp.values('office__legal_name')[:1])\r\n    ).annotate(\r\n        os_executor=Coalesce('person_executed_by__legal_name', 'office_exec')\r\n    ).filter(\r\n  \t\tos_executor__isnull=False\r\n\t).values(\r\n        'os_executor', 'person_company_representative__legal_name'\r\n    ).annotate(\r\n        total=Count('id')\r\n    ).order_by('-total')[:10]\r\nlabels = []\r\nvalues = []\r\nfor task in tasks:\r\n    labels.append([task['os_executor'], task['person_company_representative__legal_name']])\r\n    values.append(task['total'])\r\n\r\nresult = {\r\n  \"labels\": labels,\r\n  \"datasets\": [{\"label\": 'Top 10 combina\u00e7\u00e3o advogado e preposto',\r\n               \t\"data\": values,\r\n               \t\"backgroundColor\": \"#00FF00\",\r\n            \t\"borderColor\": \"#00FF00\"}]\r\n}",
        "schema": "{\r\n    \"labels\": [\r\n        \"T\u00cdTULOS DAS BARRAS: [JANEIRO, FEVEREIRO, MARCO]\"\r\n    ],\r\n    \"datasets\": [\r\n        {\r\n            \"label\": \"LABEL DO INDICADOR EX: (AUDI\\u00caCIAS POR M\\u00caS)\",\r\n            \"data\": [\r\n                \"VALORES DO INDICADOR EX: 20, 47, 50\"\r\n            ],\r\n            \"backgroundColor\": \"COR DO BACKGROUND DE FUNDO CASO FILL = True, EX: blue\",\r\n            \"borderColor\": \"COR DA BORDA DA LINHA EX: blue\"\r\n        }\r\n    ]\r\n}"
    }
},
{
    "model": "dashboard.barchart",
    "pk": 2,
    "fields": {
        "name": "Top 10 atrasos advogados",
        "code": "from django.db.models import F, ExpressionWrapper, DurationField, Case, When, BooleanField, Count, OuterRef, Q, Max, Subquery\r\nfrom django.db.models.functions import Coalesce\r\nfrom lawsuit.models import Folder\r\nfrom task.models import Task, TaskGeolocation, CheckPointType\r\nfrom django_pandas.io import read_frame\r\nimport pandas as pd\r\nimport numpy\r\nimport datetime\r\nfrom pandas import pivot_table\r\n\r\nfolders = Folder.objects.filter(person_customer__company_id=self.context.get('request').GET.get('company_id'))\r\noffice_list = list(set(folder.office.id for folder in folders))\r\noffice_corresp = Task.objects.filter(id=OuterRef('child')).order_by('-id')\r\ndtt = datetime.timedelta(0, 0, 0, 0, 30)\r\ntasks = Task.objects.filter(\r\n  \t\tQ(executed_by_checkin__isnull=False),\r\n  \t\tQ(movement__folder__in=folders),\r\n  \t\tQ(office_id__in=office_list)\r\n    ).annotate(\r\n        filho=Max('child')\r\n    ).annotate(\r\n        office_exec=Subquery(office_corresp.values('office__legal_name')[:1])\r\n    ).annotate(\r\n        os_executor=Coalesce('person_executed_by__legal_name', 'office_exec')\r\n    ).annotate(\r\n  \t\tdiff_executed_by=ExpressionWrapper(\r\n    \t\tF('final_deadline_date') - F('executed_by_checkin__create_date'), output_field=DurationField())\r\n\t).annotate(\r\n  \t\texecuted_by_late=Case(\r\n          When(executed_by_checkin__isnull=True, then=True),\r\n          When(diff_executed_by__lt=dtt, then=True), default=False, output_field=BooleanField(),)\r\n\t)\r\nqs = tasks.values('id', 'os_executor', 'executed_by_late')\r\ndf = read_frame(qs)\r\n\r\npivot_executed = pivot_table(\r\n  df, values='id', index=['os_executor'], columns=['executed_by_late'], aggfunc=lambda x: len(x), fill_value=0.0)\r\n\r\nlabels = []\r\nvalues = []\r\nif not pivot_executed.empty and 'True' in [str(k) for k in pivot_executed.keys()]:\r\n\tpivot_executed['total'] = pivot_executed.sum(axis=1)\r\n\tpivot_executed['percent_late'] = round((pivot_executed[True] / pivot_executed['total'])*100, 2)\r\n\r\n\tresult_set = pivot_executed[\r\n      pivot_executed.percent_late > 0.0].sort_values(\r\n      ['percent_late', 'total', 'os_executor'], ascending=[False, False, True]\r\n    )[:10]\r\n\r\n\tlabels = list(result_set.T)\r\n\tvalues = list(result_set['percent_late'])\r\n    \r\nresult = {\r\n  \"labels\": labels,\r\n  \"datasets\": [{\"label\": 'Top 10 advogados atrasados',\r\n               \t\"data\": values,\r\n               \t\"backgroundColor\": \"#FF0000\",\r\n            \t\"borderColor\": \"#FF0000\"}]\r\n}",
        "schema": "{\r\n    \"labels\": [\r\n        \"T\\u00cdTULOS DAS BARRAS: [JANEIRO, FEVEREIRO, MARCO]\"\r\n    ],\r\n    \"datasets\": [\r\n        {\r\n            \"label\": \"LABEL DO INDICADOR EX: (AUDI\\u00caNCIAS POR M\\u00caS)\",\r\n            \"data\": [\r\n                \"VALORES DO INDICADOR EX: 20, 47, 50\"\r\n            ],\r\n            \"backgroundColor\": \"COR DO BACKGROUND DE FUNDO CASO FILL = True, EX: blue\",\r\n            \"borderColor\": \"COR DA BORDA DA LINHA EX: blue\"\r\n        }\r\n    ]\r\n}"
    }
},
{
    "model": "dashboard.barchart",
    "pk": 3,
    "fields": {
        "name": "Top 10 atrasos prepostos",
        "code": "from django.db.models import F, ExpressionWrapper, DurationField, Case, When, BooleanField, Count, OuterRef, Q, Max, Subquery\r\nfrom django.db.models.functions import Coalesce\r\nfrom lawsuit.models import Folder\r\nfrom task.models import Task, TaskGeolocation, CheckPointType\r\nfrom django_pandas.io import read_frame\r\nimport pandas as pd\r\nimport numpy\r\nimport datetime\r\nfrom pandas import pivot_table\r\n\r\nfolders = Folder.objects.filter(person_customer__company_id=self.context.get('request').GET.get('company_id'))\r\noffice_list = list(set(folder.office.id for folder in folders))\r\ndtt = datetime.timedelta(0, 0, 0, 0, 30)\r\ntasks = Task.objects.filter(\r\n  \t\tQ(company_representative_checkin__isnull=False),\r\n  \t\tQ(movement__folder__in=folders),\r\n  \t\tQ(office_id__in=office_list)\r\n    ).annotate(\r\n  \t\tdiff_company_representative=ExpressionWrapper(\r\n    \t\tF('final_deadline_date') - F('company_representative_checkin__create_date'), output_field=DurationField())\r\n\t).annotate(\r\n  \t\tcompany_representative_late=Case(\r\n          When(company_representative_checkin__isnull=True, then=True),\r\n          When(diff_company_representative__lt=dtt, then=True), default=False, output_field=BooleanField(),)\r\n\t)\r\nqs = tasks.values('id', 'person_company_representative__legal_name', 'company_representative_late')\r\ndf = read_frame(qs)\r\n\r\npivot_company_representative = pivot_table(\r\n  df, values='id', index=['person_company_representative__legal_name'], \r\n  columns=['company_representative_late'], aggfunc=lambda x: len(x), fill_value=0.0)\r\n\r\nlabels = []\r\nvalues = []\r\nif not pivot_company_representative.empty and 'True' in [str(k) for k in pivot_company_representative.keys()]:\r\n\tpivot_company_representative['total'] = pivot_company_representative.sum(axis=1)\r\n\tpivot_company_representative['percent_late'] = round(\r\n    \t(pivot_company_representative[True] / pivot_company_representative['total'])*100, 2)\r\n\r\n\tresult_set = pivot_company_representative[\r\n      pivot_company_representative.percent_late > 0.0].sort_values(\r\n  \t\t['percent_late', 'total', 'person_company_representative__legal_name'], ascending=[False, False, True])[:10]\r\n\r\n\tlabels = list(result_set.T)\r\n\tvalues = list(result_set['percent_late'])\r\n    \r\nresult = {\r\n  \"labels\": labels,\r\n  \"datasets\": [{\"label\": 'Top 10 prepostos atrasados',\r\n               \t\"data\": values,\r\n               \t\"backgroundColor\": \"#FF0000\",\r\n            \t\"borderColor\": \"#FF0000\"}]\r\n}",
        "schema": "{\r\n    \"labels\": [\r\n        \"T\\u00cdTULOS DAS BARRAS: [JANEIRO, FEVEREIRO, MARCO]\"\r\n    ],\r\n    \"datasets\": [\r\n        {\r\n            \"label\": \"LABEL DO INDICADOR EX: (AUDI\\u00caNCIAS POR M\\u00caS)\",\r\n            \"data\": [\r\n                \"VALORES DO INDICADOR EX: 20, 47, 50\"\r\n            ],\r\n            \"backgroundColor\": \"COR DO BACKGROUND DE FUNDO CASO FILL = True, EX: blue\",\r\n            \"borderColor\": \"COR DA BORDA DA LINHA EX: blue\"\r\n        }\r\n    ]\r\n}"
    }
}
]
