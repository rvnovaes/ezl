{% extends 'inicial.html' %}
{% load staticfiles %}
{#{% load formset_tags %}#}
{% load tz %}
{% block content %}
    <div class="container">
        <form class="container" action="" method="post">{% csrf_token %}


            <script type="text/javascript">

                var nextState = {
                    ACCEPTED: {text: "aceitar", icon: "assignment_ind"},
                    REFUSED: {text: "recusar", icon: "assignment"},
                    DELEGATED: {text: "delegar", icon: "assignment_returned"},
                    DONE: {text: "Cumprir", icon: "assignment_turned_in"}
                };
                function getId(value) {
                    var actionButton = document.getElementById("actionButton");
                    var nextText = document.getElementById("actionText");
                    var id = value.id;
                    var icon = document.getElementById("icon");
                    var modalHeader = document.getElementById("modalHeader");

                    nextText.innerHTML = nextState[id]['text'];
                    icon.innerHTML = nextState[id]['icon'];

                    modalHeader.setAttribute("class", "panel-header panel-heading" + " " + id);

                    actionButton.setAttribute("name", "action");
                    actionButton.setAttribute("value", id);
                }
            </script>
            {% include 'core/widgets/messages.html' %}
            <div class="panel">
                <div class="panel-heading {{ form.instance.status.name }}">
                    <div class="panel-title"><i class="material-icons">{{ form.instance.status.get_icon }}</i>
                        <b>{{ form.instance.status|default_if_none:"" }}
                            #{{ form.instance.legacy_code|default_if_none:"" }}
                            - {{ form.instance.type_task|lower|capfirst }}</b>
                    </div>
                </div>
                <div class="panel-body form-group is-focused">
                    <div class="form-row">

                        <label>Dados do Solicitante: </label><br>
                        {{ form.instance.person_asked_by|capfirst|default_if_none:"" }}
                        <br><br>
                        <label>Detalhes do Serviço: </label>
                        <br>
                        <span class="type-LineString "><b>Prazo:</b>
                            {{ form.instance.final_deadline_date|localtime|default_if_none:"" }}</span>
                        <br>
                        <span>Recebida em: {{ form.instance.delegation_date|localtime|default_if_none:"" }}</span>
                        <br>
                        <span>Serviço solicitado: {{ form.instance.type_task|lower|capfirst|default_if_none:"" }}</span>

                    </div>
                    <div class="form-group text-center">
                        <a id="ACCEPTED" onclick="getId(this)" data-toggle="modal" data-target="#confirmAction"
                           class="btn btn-sm btn-raised ACCEPTED {% if not form.instance.status.name == 'OPEN' %}hidden{% endif %}">
                            <i class="material-icons left" style="color: white;">assignment_ind</i>
                            Aceitar
                        </a>
                        <a id="REFUSED" onclick="getId(this)" data-toggle="modal" data-target="#confirmAction"
                           class="btn btn-sm btn-raised REFUSED {% if not form.instance.status.name == 'OPEN' %}hidden{% endif %}"><i
                                class="material-icons left" style="color: white;">assignment_late</i>
                            Recusar
                        </a>
                        <a id="DELEGATE" onclick="getId(this)" data-toggle="modal" data-target="#confirmAction"
                           class="btn btn-sm btn-raised DELEGATE {% if not form.instance.status.name == 'DELEGATE' %}hidden{% endif %}"
                           href=""><i
                                class="material-icons left" style="color: white">assignment_return</i>
                            Delegar
                        </a>
                        {% if form.instance.status.name == 'ACCEPTED' or form.instance.status.name == 'RETURN' %}
                            <a>{{ form.execution_date }}</a>
                            <a onclick="getId(this)" id="DONE" type="submit" data-toggle="modal"
                               data-target="#confirmAction"
                               class="btn btn-sm btn-raised DONE ">
                                <i class="material-icons left" style="color: white">assignment_turned_in</i>
                                Cumprir
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Arquivos GED -->

            <div class="panel panel-primary">
                <div class="panel-heading " data-toggle="collapse" data-target="#attachment" id="header-attachment"
                     onclick="toggleArrow()">
                    <div class="panel-title"><i class="material-icons">attach_file</i>
                        <b>Anexar Arquivos</b>
                        <i class="material-icons" style="float: right;" id="down">arrow_drop_down</i>
                        <i class="material-icons" style="float: right; display: none;" id="up">arrow_drop_up</i>
                    </div>
                </div>
                <div id="attachment" class="panel-collapse collapse">
                    <div class="panel-body form-group is-focused">
                        <button type="button" class="btn btn-sm btn-primary btn-raised js-upload-files"
                                style="color: #fff !important;">
                            <i class="material-icons">cloud_upload</i> &nbsp; Enviar Arquivo(s)
                        </button>

                        <input id="fileupload" type="file" name="path" multiple
                               style="display: none;"
                               data-method="POST"
                               enctype="multipart/form-data"
                               data-url="{% url 'ecm_add' object.id %}"
                               data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'>
                        <br>
                        <br>

                        <p class="text-center" id="no-providence">
                            {% if geds|length == 0 %}
                                Esta providência não possui nenhum arquivo em
                                anexo.
                            {% endif %}
                        </p>
                        <div class="table-responsive">
                            <table id="files" class="table table-bordered table-responsive">
                                <tbody>
                                {% for ged in geds %}
                                    <tr class="lineFile" id="row-{{ ged.id }}">
                                        <td id="cell-table">
                                            <div class="row" id="row-file">
                                                <div class="col-sm-2"
                                                     style="text-align: center !important; vertical-align: middle !important;">
                                                    <i class="material-icons">person_pin</i>
                                                </div>
                                                <div class="col-sm-8" style="text-align: left; padding-left: 0;">
                                                    <h6 style="margin-bottom: 3px !important;">{{ ged.user.first_name }} {{ ged.user.last_name }}
                                                        ({{ ged.create_user }})
                                                    </h6>

                                                    <div style="font-size: x-small">
                                                        {{ ged.create_date|localtime }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td id="cell-table" style="font-size: small; width: 70% !important;">
                                            <a href="/media/{{ ged.path }}" download
                                               style="text-decoration: none;">{{ ged.filename }}</a>
                                        </td>
                                        <td id="cell-table" style="font-size: small">
                                            <i class="material-icons" id="" style="cursor: pointer; font-size: medium;"
                                               data-toggle="modal"
                                               data-target="#confirmDelete-{{ ged.id }}">delete</i>
                                        </td>
                                    </tr>
                                    <tr class="spaceFile" id="row-space{{ ged.id }}"></tr>

                                    <!-- Janela modal para confirmação de deleção de arquivo -->
                                    <div id="confirmDelete-{{ ged.id }}" class="modal">
                                        <div class="modal-dialog">
                                            <div class="modal-content ">
                                                <div class="modal-body" style="text-align: center !important;">
                                                    Tem certeza que deseja excluir o arquivo <b>{{ ged.filename }}</b> ?
                                                </div>
                                                <div class="modal-footer">
                                                    <div class="form-group text-center">
                                                        <button type="button" style="width: 95px!important;"
                                                                class="btn btn-sm btn-raised btn-default"
                                                                data-dismiss="modal">
                                                            Não
                                                        </button>
                                                        <button value="1" id="delete-ecm-{{ ged.id }}"
                                                                style="width: 95px!important;"
                                                                class="btn btn-sm btn-raised btn-primary"
                                                                data-dismiss="modal">Sim
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                <!-- DIV para o Ajax localizar o local (pelo ID) onde será incluído o conteúdo das novas janelas modais
                                a medida que for adicionando novos arquivos -->
                                <div id="modals">
                                </div>
                                </tbody>
                            </table>
                        </div>

                        <!-- Janela modal para mostrar progresso do envio de arquivos -->

                        <div class="modal fade" id="modal-progress" data-backdrop="static" data-keyboard="false">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title" style="text-align: center">Enviando ...</h4>
                                    </div>
                                    <div class="modal-body">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>

            <!-- Modal -->
            <div id="confirmAction" class="modal">
                <div class="modal-dialog">
                    <div class="modal-content ">
                        <div id="modalHeader">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h4 class="panel-title text-center">
                                <i id="icon" class="material-icons "></i>
                                <b> Deseja <span id="actionText">aceitar</span> o prazo?</b></h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group" style="margin: auto">
                                <label> {{ form.notes.label }}</label>
                                {{ form.notes }}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="form-group text-center">
                                <button type="button" style="width: 95px!important;"
                                        class="btn btn-sm btn-raised btn-default"
                                        data-dismiss="modal">
                                    Cancelar
                                </button>
                                <button value="1" id="actionButton" type="submit" style="width: 95px!important;"
                                        class="btn btn-sm btn-raised btn-primary">Sim
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>


    <!-- Janela modal para mostrar sucesso ao deletar arquivo -->
    <div id="deleteSuccess" class="modal">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center !important;">
                    <p id="message-delete-success">
                    </p>
                </div>
                <div class="modal-footer">
                    <div class="form-group text-center">
                        <button type="button" style="width: 95px!important;"
                                class="btn btn-sm btn-raised btn-primary"
                                data-dismiss="modal">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Janela modal para mostrar erro ao deletar arquivo -->
    <div id="deleteError" class="modal">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center !important;">
                    {#                    Ocorreu um erro ao tentar excluir o arquivo.#}
                    <p id="deleteErrorText">

                    </p>
                </div>
                <div class="modal-footer">
                    <div class="form-group text-center">
                        <button type="button" style="width: 95px!important;"
                                class="btn btn-sm btn-raised btn-primary"
                                data-dismiss="modal">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Janela modal para mostrar progresso de deleção do arquivo -->
    <div id="deleting" class="modal">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center;">
                    Excluindo arquivo ...
                </div>
                <div class="modal-footer">
                    <div class="progress progress-striped active">
                        <div class="progress-bar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Janela modal para mostrar sucesso ao enviar arquivo -->
    <div id="sucessSent" class="modal">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center !important;">
                    <p id="message-success-sent">
                    </p>
                </div>
                <div class="modal-footer">
                    <div class="form-group text-center">
                        <button type="button" style="width: 95px!important;"
                                class="btn btn-sm btn-raised btn-primary"
                                data-dismiss="modal">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Janela modal para mostrar erro ao enviar arquivo -->
    <div id="errorSent" class="modal">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-body" style="text-align: center !important;">
                    <p id="error-message">

                    </p>
                </div>
                <div class="modal-footer">
                    <div class="form-group text-center">
                        <button type="button" style="width: 95px!important;"
                                class="btn btn-sm btn-raised btn-primary"
                                data-dismiss="modal">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% block javascript %}
        <script src="{% static 'libs/jQuery-File-Upload/js/vendor/jquery.ui.widget.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.iframe-transport.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/jquery.fileupload.js' %}"></script>
        <script src="{% static 'libs/jQuery-File-Upload/js/basic-upload.js' %}"></script>

        {% for ged in geds %}
            <script>
                $("#delete-ecm-{{ ged.id }}").click(function () {
                        $('#deleting').modal('show');
                        $.ajax({
                            url: '{% url 'delete_ecm' ged.id %}',
                            dataType: 'json',

                            success: function (data) {
                                if (data.is_deleted) {
                                    document.getElementById("message-delete-success").innerHTML = data.message;
                                    $('#row-{{ ged.id }}').remove();
                                    $('#row-space{{ ged.id }}').remove();
                                    $('#deleting').modal('hide');
                                    $('#deleteSuccess').modal('show')

                                }
                                else {
                                    document.getElementById("deleteErrorText").innerHTML = data.message;
                                    $('#deleting').modal('hide');
                                    $('#deleteError').modal('show')
                                }

                                if (data.num_ged == 0) {
                                    document.getElementById("no-providence").innerHTML = "Esta providência não possui nenhum arquivo em anexo.";
                                }
                            }
                        })
                    }
                );
            </script>
        {% endfor %}
        <!-- DIV para o Ajax localizar o local (pelo ID) onde será incluído os novos scripts de deleção
             a medida que for adicionando novos arquivos -->
        <div id="scripts">
        </div>
        <script>
            var expanded = false;

            function toggleArrow() {

                if (expanded) {
                    expanded = false;
                    document.getElementById("up").style.display = "none";
                    document.getElementById("down").style.display = "block";
                }
                else {
                    expanded = true;
                    document.getElementById("up").style.display = "block";
                    document.getElementById("down").style.display = "none";
                }
            }
        </script>
    {% endblock %}
{% endblock content %}