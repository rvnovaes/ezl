{% extends "skeleton/base.html" %}

{% load staticfiles %}

{% block extra_stylesheets %}
<link href="{% static 'skeleton/plugins/bower_components/datatables/jquery.dataTables.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'skeleton/plugins/bower_components/dropify/dist/css/dropify.min.css' %}" rel="stylesheet" type="text/css" />
<link href="//cdn.datatables.net/buttons/1.2.2/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
{% load staticfiles bootstrap3 %}
    
    {% include 'core/widgets/messages.html' %}
    
    <form id="import_task_list_form" action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
            <!--Campo para upload do arquivo -->            
            <div class="form-group col-sm-12">
                <label class="control-label" for="id_file_xls">Arquivo</label>
                <div class="row bootstrap3-multi-input">
                    <div class="col-xs-12" style="width: 400px;">
                        <input type="file" name="file_xls" class="dropify" title="" required="" id="id_file_xls">
                    </div>
                </div>
            </div>            
        </div>

        <br>
        <button id="btn-submit"
            style="width: 100px!important;"
            type="button"
            onclick="showMessages()"
            class="btn btn-success waves-effect waves-light">Importar
        </button>        
        <script>
            function showMessages()
            {                                                                              
                var text_msg = "Ao iniciar o processo de importação de tabela de preços não será possível cancelá-lo. Deseja continuar?"
                swal({
                        title: "Importante",
                        text: text_msg,
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Sim",
                        cancelButtonText: "Não",
                        confirmButtonColor: "#DD6B55",
                        closeOnConfirm: false
                    }, function(isConfirm){
                        if (isConfirm) {
                            swal.close();
                            $('#processing').modal({backdrop: 'static', keyboard: false});
                            var formData = new FormData($('#import_task_list_form')[0]);
                            $.ajax({
                                type: 'POST',
                                url: window.location,
                                data: formData,
                                contentType: false,
                                processData: false,
                                success: function (result) {
                                    var $total_rows = $("#total_rows");
                                    $total_rows[0].getElementsByTagName('span')[0].innerHTML = result.total_rows;
                                    $total_rows.css('display', 'block');
                                    if(result.totals){
                                        $.each(result.totals, function(key, val){
                                            $("#"+key).html(val)
                                        });
                                        $("#totals").css('display', 'block');
                                    } else {
                                        $("#totals").css('display', 'none');
                                    }
                                    $("#id_file_xls").val('');
                                    if(result.errors.length){
                                        var log_table = $('#log_table');
                                        log_table.DataTable().destroy()
                                        var log_table_tbody = $('#log_table tbody');
                                        log_table_tbody.html('')
                                        for (var j = 0; j < result.errors.length; j++) {
                                            var result_error_obj = result.errors[j]
                                            var errors_desc = '';
                                            for (var i = 0; i < result_error_obj.errors[0].length; i++) {
                                                errors_desc += $.trim(result_error_obj.errors[0][i]).split("'").join('') + '<br />';
                                            }
                                            log_table_tbody.append('<tr> ' +
                                                '<td>' + result_error_obj.line + '</td>' +
                                                '<td>' + errors_desc + '</td></tr>');
                                        }
                                        $("#div-log-table").css('display', 'block');
                                        log_table.DataTable({
                                            language: {
                                                "url": "//cdn.datatables.net/plug-ins/1.10.16/i18n/Portuguese-Brasil.json"
                                            },
                                            buttons: [
                                                'copy', 'csv', 'excel', 'pdf', 'print'
                                            ],
                                            destroy: true,
                                        });
                                    }else{
                                        $("#div-log-table").css('display', 'none');
                                    }
                                    var drEvent = window.file_xls_field.dropify();
                                    drEvent = drEvent.data('dropify');
                                    drEvent.resetPreview();
                                    drEvent.clearElement();
                                    $('#processing').modal('hide');
                                },
                                error: function (request, status, error) {
                                    $('#processing').modal('hide');
                                    window.location.reload()
                                },
                                beforeSend: function (xhr, settings) {
                                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                                },
                                dataType: 'json'
                            })
                        }
                    }
                );
            }
        </script>
    </form>
    
    <br>
    <div class="col-xs-12 form-group"  id="total_rows" style="display: none">
        <label>Total importado: </label>&nbsp;<span></span>
    </div>
    <div id="totals" class="col-xs-12" style="display: none">
        <label>Detalhe dos registros importados:</label>
        <ul>
            <li>Novos: <span id="new"></span></li>
            <li>Atualizados: <span id="update"></span></li>
            <li>Apagados: <span id="delete"></span></li>
            <li>Ignorados: <span id="skip"></span></li>
            <li>Com erro: <span id="error"></span></li>
        </ul>
    </div>
    <div id="div-log-table" style="display: none">
            <table id="log_table">
            <thead>
                <tr>
                    <th colspan="2">Log de errors do processo</th>
                </tr>
                <tr>
                    <th>Linha</th>
                    <th>Erros</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    {% include 'task/modal/processing.html' %}
{% endblock %}


{% block extra_scripts %}
    <script src="{% static 'skeleton/plugins/bower_components/dropify/dist/js/dropify.min.js' %}"></script>    
    <script src="{% static 'skeleton/plugins/bower_components/styleswitcher/jQuery.style.switcher.js' %}"></script>
    <script src="{% static 'skeleton/plugins/bower_components/datatables/jquery.dataTables.min.js' %}"></script>
    <!-- start - This is for export functionality only -->
    <script src="//cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js"></script>
    <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.print.min.js"></script>
    <script>
        $('document').ready(function(){
            window.file_xls_field = $('.dropify');
            window.file_xls_field.attr('data-height', '200').attr('data-allowed-file-extensions', 'xlsx').dropify()
        })
    </script>
{% endblock %}