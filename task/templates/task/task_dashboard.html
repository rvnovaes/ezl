{% extends 'inicial.html' %}
{% load django_tables2 %}
{% load static %}
{% load querystring from django_tables2 %}
{% load bootstrap3 %}
{% block content %}
    {#    <div class="container form-group"><label class="is-focused"><h2>{{ title_page }}</h2></label></div>#}
    {% include 'core/widgets/messages.html' %}
    {% for message in messages %}      
    {%endfor%}
    {% block table %}
        <div class="container">
            {% if table.page %}
                <div class="table-container">
            {% endif %}
            {% for table in tables %}
                <div class="panel">
                    <div class="panel-heading {{ table.status.name }}" data-toggle="collapse"
                         data-target="#{{ table.status.name }}">
                        <div class="panel-title"><i
                                class="material-icons">{{ table.status.get_icon }}</i>
                            <b>{{ table.title }} ({{ table.length }})</b></div>
                    </div>
                    <div id="{{ table.status.name }}" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    {% block table.thead %}
                                        <thead>
                                        <tr>
                                            {% for column in table.columns %}
                                                {% if column.orderable %}
                                                    <th {{ column.attrs.th.as_html }}><a
                                                            href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|title }}</a>
                                                    </th>
                                                {% else %}
                                                    <th {{ column.attrs.th.as_html }}>{{ column.header|title }}</th>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                        </thead>
                                    {% endblock table.thead %}
                                    {% block table.tbody %}
                                        <tbody>
                                        {% for row in table.page.object_list|default:table.rows %}
                                            {# support pagination #}
                                            {% block table.tbody.row %}
                                                <tr class="{% cycle "odd" "even" %}" data-new-href="{{ row.attrs.data_new_href }}" data-task data-task-id="{{ row.record.id}}" data-task-status="{{ row.record.status}}">
                                                    {% for column, cell in row.items %}
                                                        <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endblock table.tbody.row %}
                                        {% empty %}
                                            {% if table.empty_text %}
                                                {% block table.tbody.empty_text %}
                                                    <tr>
                                                        <td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td>
                                                    </tr>
                                                {% endblock table.tbody.empty_text %}
                                            {% endif %}
                                        {% endfor %}
                                        </tbody>
                                    {% endblock table.tbody %}
                                    {% block table.tfoot %}
                                        <tfoot></tfoot>
                                    {% endblock table.tfoot %}
                                </table>
                            </div>
                            {% if table.page %}
                                {% block pagination %}
                                    {% bootstrap_pagination table.page url=request.get_full_path parameter_name=table.prefixed_page_field %}
                                {% endblock pagination %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
    {% endblock table %}
{% endblock content %}

{% block javascript %}{{ block.super }}
<script>
    $(document).ready(function(){
        var tasks = [];
        $('[data-task]').each(function(){
            var task = $(this),
                status = task.attr('data-task-status'),
                id = parseInt(task.attr('data-task-id'));
            tasks.push([id, status]);
        });

        setInterval(function(){
            $.ajax({
                type: "POST",
                url: "/dashboard/verificar_status/",
                data: {"tasks": JSON.stringify(tasks)},
                success: function(response){
                    if (response.has_changed) {
                        location.reload();
                    }
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                dataType: "json"
            });
        }, 500);
    });
</script>
{% endblock %}
