
{% extends 'skeleton/base.html' %}
{% load static core_match %}
{% load task_filters %}

{% block extra_stylesheets %}
    <link href="{% static 'skeleton/plugins/bower_components/datatables/jquery.dataTables.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="//cdn.datatables.net/buttons/1.2.2/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css" />
    <style>
        table.dataTable.row-border tbody tr:first-child th, table.dataTable.row-border tbody tr:first-child td, table.dataTable.display tbody tr:first-child th, table.dataTable.display tbody tr:first-child td {
            font-size: small !important;
            cursor: pointer;
        }
        tr {
            cursor: pointer;
        }
        #taskeTable {
            overflow: auto;
        }
    </style>
{% endblock %}
{% block content %}
    {% include 'core/widgets/messages.html' %}
    {% for message in messages %}
    {%endfor%}
    <div class="col-md-12">
        <div class="row">
            <div class="row">
                <div class="col-md-6 col-sm-6" id="id_total">
                    <div class="white-box">
                        <h3 class="box-title m-b-0">Total</h3>
                        <h1 id="total" class="m-b-0 m-t-0 font-medium">{{ ret_status_dict.total }}</h1>
                    </div>
                </div>
                <div class="col-md-6 col-sm-6">
                    <div class="white-box">
                        <h3 class="box-title m-b-0">OS's solicitadas no m&ecirc;s</h3>
                        <h1 id="total_requested_month" class="m-b-0 m-t-0 font-medium">{{ ret_status_dict.total_requested_month }}</h1>
                    </div>
                </div>
            </div>
            {% for status_name, status_items in ret_status_dict.items %}
                {% if status_items.name and status_items.title != 'Inválida'%}
                    {% if not cards_to_show or status_items.status in cards_to_show %}
                    <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12" id="id_{{ status_items.name|lower }}">
                        <a {% if status_items.total %}href="#modal-view-task-table" data-toggle="modal"{% else %}href="javascript:swal('Não há dados para exibir.')"{% endif %} data-status="{{ status_items.status }}">
                        <div class="white-box">
                            <h5 class="font-bold ezl-text-{{ status_items.name|lower }}" style="min-height: 32px">{{ status_items.title }}</h5>
                            <div class="text-left">
                                <h1>
                                    <sup>
                                        <i class="{{ status_items.task_icon }} ezl-text-{{ status_items.name|lower }} font-30"></i>
                                    </sup>
                                    <span id="{{ status_items.status|remove_spaces_lower }}" class="pull-right status-total">{{status_items.total}}</span>
                                </h1>
                            </div>{% get_percent status_items.total ret_status_dict.total as percent %}
                            <span class="text-success" id="{{ status_items.status|remove_spaces_lower }}_percent">{{ percent|stringformat:".02f" }}%</span> <div class="progress m-b-0">
                            <div id="{{ status_items.status|remove_spaces_lower }}_percent_bar" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="{{ percent|stringformat:"d" }}" aria-valuemin="0" aria-valuemax="100" style="width:{{ percent|stringformat:"d" }}%;">
                                <span class="sr-only">{{ percent|stringformat:".02d" }}% Complete</span> </div>
                            </div>
                        </div>
                        </a>
                    </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_scripts %}
    <script src="{% static 'skeleton/plugins/bower_components/datatables/jquery.dataTables.min.js' %}?rev={{request.REVIEW}}"></script>
    <script src="{% static 'task/task_dashboard.js' %}?rev={{request.REVIEW}}"></script>
    <!-- start - This is for export functionality only -->
    <script src="//cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js"></script>
    <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>
    <script src="//cdn.datatables.net/buttons/1.2.2/js/buttons.print.min.js"></script>
    <!-- plugin para classificar por data -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script src="//cdn.datatables.net/plug-ins/1.10.16/sorting/datetime-moment.js"></script>
{% endblock %}

{% block script_document_ready %}
        $('#modal-view-task-table').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var status = button.data('status');
            var columnsDict = getColumns(status);
            $.fn.dataTable.moment( 'DD/MM/YYYY HH:mm' );

            var table = $('#taskeTable').DataTable({
                pageLength: 5,
                dom: 'Bfrtip',
                order: [[2, 'asc']],
                processing: true,
                serverSide: true,
                ajax: {url: '{% url 'ajax_get_task_data_table' %}?status=' + status,
                    data: function(d){
                        d['order'].forEach(function(items, index) {
                              d['order'][index]['column'] = d['columns'][items.column]['data'];
                        });
                        return {"data": JSON.stringify(d)};
                    }},
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    "url": "//cdn.datatables.net/plug-ins/1.10.16/i18n/Portuguese-Brasil.json"
                },
                columns: columnsDict.columns,
                columnDefs: columnsDict.columnDefs
            });
            $('#taskeTable tbody').on( 'click', 'tr', function () {
                var pk = table.row( this ).data()['pk'];
                window.open('/dashboard/' + pk,'_blank');
            });
        });
        /* Ao fechar o modal, limpar a tabela */
        $('#modal-view-task-table').on('hidden.bs.modal', function (event) {
            $('#taskeTable').empty();
            $('#taskeTable').DataTable().clear().destroy();
        });

        function verify_status() {
            return setInterval(function(){
                $.ajax({
                    type: "GET",
                    url: "/dashboard/verificar_status/",
                    success: function(response){
                        $("#current_office").html(response.office);
                        $.each($('.status-total'), function (index, value){
                            if (!(value.id in response)) {
                                $("#"+value.id).html('0');
                                $("#"+value.id+"_percent").html("0.00%");
                                $("#"+value.id+"_percent_bar").prop('aria-valuenow', 0);
                                $("#"+value.id+"_percent_bar").css('width', '0%');
                            }
                        })
                        $.each(response, function (index, value) {
                            $("#"+index).html(value);
                            if(index !== 'total' && index !== 'total_requested_month'){
                                var percent = (response.total > 0) ? parseFloat((value/response.total)*100) : parseFloat(0);
                                $("#"+index+"_percent").html(percent.toFixed(2) + "%");
                                $("#"+index+"_percent_bar").prop('aria-valuenow', Math.round(percent));
                                $("#"+index+"_percent_bar").css('width', Math.round(percent)+'%');
                            }
                        });
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                    },
                    dataType: "json"
                });
            }, 3000);
        };

        window.interval_status;
        $(document).ready(function(){
            window.interval_status = verify_status()
            $(window).on('focus', function(){
                window.interval_status = verify_status()
            });
            $(window).on('focusout', function(){
                clearInterval(window.interval_status);
            });
        });
{% endblock %}

{% block extra_modal %}
    {% include 'task/modal/view-task-table.html' %}
{% endblock %}
