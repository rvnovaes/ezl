# -*- coding: utf-8 -*-
# Generated by Django 1.11.16 on 2018-11-07 20:42
from __future__ import unicode_literals

from django.db import migrations
import json


def migrate_survey_result(apps, schema_editor):
    Task = apps.get_model('task', 'Task')
    TaskSurveyAnswer = apps.get_model('task', 'TaskSurveyAnswer')
    User = apps.get_model('auth', 'User')

    admin = User.objects.filter(username='admin').first()

    if admin:
        tasks = Task.objects.filter(survey_result__isnull=False).exclude(survey_result='')
        count = tasks.count()
        fields = ['id', 'execution_date', 'person_executed_by__auth_user', 'survey_result',
                  'person_distributed_by__auth_user']
        for x, values in enumerate(tasks.values_list(*fields)):
            if x % 100 == 0:
                print("{} of {}".format(x, count))
            task = Task.objects.get(id=values[0])
            create_user = values[2] or values[4] or admin.id
            if create_user is None:
                print("Sem usu√°rio:", task.id)
                continue
            survey_result = values[3]
            if not getattr(survey_result, 'items', None):
                survey_result = json.loads(survey_result)
            TaskSurveyAnswer.objects.create(
                task_id=values[0],
                create_date=values[1],
                create_user_id=create_user,
                survey_result=survey_result
            )


def clear_survey_result(apps, schema_editor):
    TaskSurveyAnswer = apps.get_model('task', 'TaskSurveyAnswer')
    TaskSurveyAnswer.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('task', '0127_auto_20181029_1711'),
    ]

    operations = [
        migrations.RunPython(migrate_survey_result, clear_survey_result),
    ]
