{% extends 'inicial.html' %}
{% load staticfiles %}
{% block head %}
  {{block.super}}
  {% block css_head %}
    {{block.super}}
    <link rel="stylesheet" href="{% static "chat/css/chat-bakp.css" %}">
  {% endblock %}
{% endblock %}
{% block content %}
  <h1>Chat</h1>
  <div class="container">
    {% for chat in chats %}
      <div class="row">
          <div class="col-md-10 col-md-offset-1">
              <div class="panel panel-primary">
                  <div class="panel-heading" id="{{chat.label}}">
                      <span class="glyphicon glyphicon-comment"></span> Chat {{chat.label}}
                      <div class="btn-group pull-right">
                          <a type="button" class="btn btn-default btn-xs" data-toggle="collapse" data-parent="#{{chat.label}}" href="#{{chat.pk}}">
                              <span class="glyphicon glyphicon-chevron-down"></span>
                          </a>
                      </div>
                  </div>                  
                <div class="panel-collapse collapse" id="{{chat.pk}}">
                    <div class="chat panel-body">
                        <ul class="chat" data-id={{chat.pk}}>
                           {% for message in chat.messages.all %}
                              {% if message.create_user == user %}
                              <li class="right clearfix"><span class="chat-img pull-right">
                                  <img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />
                              </span>
                                  <div class="chat-body clearfix">
                                      <div class="header">
                                          <small class=" text-muted"><span class="glyphicon glyphicon-time"></span>13 mins ago</small>
                                          <strong class="pull-right primary-font">{{message.create_user}}</strong>
                                      </div>
                                      <p>
                                          {{message.message}}
                                      </p>
                                  </div>
                              </li>
                              {% else %}
                                <li class="left clearfix"><span class="chat-img pull-left">
                                    <img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" />
                                </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font">{{message.create_user}}</strong> <small class="pull-right text-muted">
                                                <span class="glyphicon glyphicon-time"></span>12 mins ago</small>
                                        </div>
                                        <p>
                                          {{message.message}}
                                        </p>
                                    </div>
                                </li>
                              {% endif %}
                           {% endfor %}
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Digite aqui sua mensagem..." />
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="btn-chat" onclick="sendMessage('{{chat.pk}}')">
                                    Enviar</button>
                            </span>
                        </div>
                    </div>
                </div>
              </div>
          </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
{% block javascript %}
<script>
    var data = '';
    var edata = '';
    var label = "";
    $(document).ready(function () {
        $('.chat.panel-body').animate({scrollTop: 9999}, 1000);

        {% for chat in chats %}
            var label = "{{ chat.label }}";
            socket = new WebSocket("ws://" + window.location.host + "/chat/?label=" + label);
        {% endfor %}
        sendMessage = function (chatId) {
            data = JSON.stringify({
                'text': $('#' + chatId).find('#btn-input').val(),
                'chat': chatId,
                'label': label
            });
            socket.onopen(data)
        };

        {# Ao chegar uma mensagem#}
        socket.onmessage = function (e) {
            $('.chat.panel-body').animate({scrollTop: 9999}, 1000);
            data = JSON.parse(e.data);
            messagePosition = 'left';
            imgChat = 'http://placehold.it/50/55C1E7/fff&text=U';
            if ('{{user}}' === data.user) {
                messagePosition = 'right';
                imgChat = 'http://placehold.it/50/FA6F57/fff&text=ME'
            }
            elementUl = $('[data-id=' + data.chat + ']');
            li = $($.parseHTML('<li class=" ' + messagePosition + ' clearfix"><span class="chat-img pull-' + messagePosition + '"><img src="' + imgChat + '" alt="User Avatar" class="img-circle" />'))
            divBody = $($.parseHTML('<div class="chat-body clearfix"></div>'));
            divHeader = $($.parseHTML('<div class="header"> </div>'));
            small = $($.parseHTML(''));
            {#                small = $($.parseHTML('<small class=" text-muted"><span class="glyphicon glyphicon-time"></span>13 mins ago</small>'));#}
            strong = $($.parseHTML('<strong class="pull-' + messagePosition + ' primary-font">' + data.user + '</strong>'));
            p = $($.parseHTML('<p>' + data.text + '</p>'));
            elementUl.append(li.append(divBody.append(divHeader.append(small).append(strong).append(p))))
        };
        socket.onopen = function (data) {
            socket.send(data);
        }
    });
</script>
{% endblock %}