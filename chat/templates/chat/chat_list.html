{% extends 'inicial.html' %}
{% load staticfiles %}
{% block head %}
  {{block.super}}
  {% block css_head %}
    {{block.super}}
    <link rel="stylesheet" href="{% static "chat/css/chat.css" %}">
  {% endblock %}
{% endblock %}
{% block content %}
  <h1>Chat</h1>
  {{chats}}
  <div class="container">
    {% for chat in chats %}
      <div class="row">
          <div class="col-md-5">
              <div class="panel panel-primary">
                  <div class="panel-heading" id="{{chat.label}}">
                      <span class="glyphicon glyphicon-comment"></span> Chat {{chat.label}}
                      <div class="btn-group pull-right">
                          <a type="button" class="btn btn-default btn-xs" data-toggle="collapse" data-parent="#{{chat.label}}" href="#{{chat.pk}}">
                              <span class="glyphicon glyphicon-chevron-down"></span>
                          </a>
                      </div>
                  </div>
                <div class="panel-collapse collapse" id="{{chat.pk}}">
                    <div class="panel-body">
                        <ul class="chat">
                           {% for message in chat.messages.all %}
                              {% if message.create_user == user %}
                              <li class="right clearfix"><span class="chat-img pull-right">
                                  <img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />
                              </span>
                                  <div class="chat-body clearfix">
                                      <div class="header">
                                          <small class=" text-muted"><span class="glyphicon glyphicon-time"></span>13 mins ago</small>
                                          <strong class="pull-right primary-font">{{message.create_user}}</strong>
                                      </div>
                                      <p>
                                          {{message.message}}
                                      </p>
                                  </div>
                              </li>
                              {% else %}
                                <li class="left clearfix"><span class="chat-img pull-left" data-id={{chat.pk}}>
                                    <img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" />
                                </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font">{{message.create_user}}</strong> <small class="pull-right text-muted">
                                                <span class="glyphicon glyphicon-time"></span>12 mins ago</small>
                                        </div>
                                        <p>
                                          {{message.message}}
                                        </p>
                                    </div>
                                </li>
                              {% endif %}
                           {% endfor %}
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your message here..." />
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="btn-chat" onclick="sendMessage('{{chat.pk}}')">
                                    Send</button>
                            </span>
                        </div>
                    </div>
                </div>
              </div>
          </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
{% block javascript %}
<script>
    var data = '';
    $(document).ready(function(){
      socket = new WebSocket("ws://" + window.location.host + "/chat/");


      sendMessage = function(chatId) {
          console.log(($('#' + chatId)))
          data = JSON.stringify({
            'text': $('#' + chatId).find('#btn-input').val(),
            'chat': chatId
          })
          socket.onopen(data)
      }
      socket.onmessage = function(e) {
        console.log(e.data)
          // data = JSON.parse(e.data);
          // chat = $('#' + data.chat).find('<li>');
          // elementStrong = $('<strong></strong>').text(data.text)
          // elementSmall = $('<small></small>').text(data.text)
          // elementP = $('<p></p>').text(data.text)
          // chat.append(elementStrong)
          // chat.append(elementSmall)
          // chat.append(elementP)
      }
      socket.onopen = function(data) {
          console.log(data);
          socket.send(data);
      }
    });
</script>
{% endblock javascript %}
