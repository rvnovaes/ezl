{% extends 'skeleton/base.html' %}
{% load staticfiles %}


{% block content %}
    <div class="chat-main-box">
        <!-- .chat-left-panel -->
        <div class="chat-left-aside">
            <div class="open-panel"><i class="ti-angle-right"></i></div>
            <div class="chat-left-inner">
                <div class="form-material">
                    <input class="form-control p-20" type="text" placeholder="Search Contact">
                </div>
                <ul class="chatonline style-none ">
                    {% for chat in chats|dictsortreversed:'alter_date' %}
                        {% if chat.messages.all|length > 0 %}
                        <li>
                            <a href="javascript:chatGetMessages('{{ chat.pk }}')" class="mytooltip">
                                <span class="tooltip-content5"><span class="tooltip-text3"><span class="tooltip-inner2">Howdy, Ben!<br> There are 13 unread messages in your inbox.</span></span></span>
                                <div class="circle circle-sm bg-info di">OS</div>
                                <span>{{ chat.title }}</span>
                                <p class="text-muted pull-right"><i class="fa fa-clock-o"></i> {{ chat.alter_date|time }}</p>
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    <li class="p-20"></li>
                </ul>
            </div>
        </div>
        <!-- .chat-left-panel -->
        <!-- .chat-right-panel -->
        <div class="chat-right-aside">
            <div class="chat-main-header">
                <div class="p-20 b-b" id="chatMessageTitle">
                    <h3 class="box-title">Chat Message</h3>
                    <p class="box-title">Chat Message</p>
                </div>
            </div>
            <div class="chat-box">
                <ul class="chat-list slimscroll p-t-30" id="messageList">
                </ul>
                <div class="row send-chat-box">
                    <div class="col-sm-12">
                        <input class="form-control" placeholder="Digite sua mensagem" id="inputMsg"/>
                        <div class="custom-send"><a href="javacript:void(0)" class="cst-icon" data-toggle="tooltip" title="Insert Emojis"><i class="ti-face-smile"></i></a> <a href="javacript:void(0)" class="cst-icon" data-toggle="tooltip" title="File Attachment"><i class="fa fa-paperclip"></i></a>
                            <button class="btn btn-danger btn-rounded" type="button">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- .chat-right-panel -->
    </div>
    </div>

{% endblock %}


{% block extra_scripts %}
    <script src="{% static 'skeleton/js/chat.js' %}"></script>
    <script src="{% static 'skeleton/plugins/bower_components/jquery.tmpl/jquery.tmpl.js' %}"></script>

    <script>
        var tmplMsgLi = '<li class="${odd}">\n' +
            '  <div class="chat-image">\n' +
            '    <div class="circle circle-sm bg-info di"> <i class="fa fa-user"></i></div>\n' +
            '  </div>\n' +
            '  <div class="chat-body">\n' +
            '    <div class="chat-text">\n' +
            '        <h4>${user}</h4>\n' +
            '        <p>${message}</p> <b>${message_create_date}</b> ' +
            '    </div>\n' +
            '  </div>\n' +
            '</li>\n';

        var tmplChatMessageTitle = '<h4 class="box-title"><a href="${back_url}">${title}</a></h4>\n' +
                                   '<p>${description}</p>';

        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/?label=" + label);
        {# Ao chegar uma mensagem#}
        socket.onmessage = function (e) {
            data = JSON.parse(e.data);
            if ('{{user}}' === data.user) {
                data.odd =  "odd bounceInRight animated";
                $.tmpl(tmplMsgLi, data).appendTo("#messageList")
            }else {
                data.odd =  "bounceInLeft animated";
                $.tmpl(tmplMsgLi, data).appendTo("#messageList")
            }
            var bottomCoord = $('#messageList')[0].scrollHeight;
            $('#messageList').slimScroll({scrollTo: bottomCoord});
        };
        socket.onopen = function (data) {
            socket.send(data);
        };
        function sendMessage(chatId) {
            var el = $('#inputMsg');
            if (el.val().trim()) {
                data = JSON.stringify({
                    'text': el.val(),
                    'chat': chatId,
                    'label': 'label'
                });
                el.val(null);
                socket.onopen(data)
            }
        }

        function chatGetMessages(chat_id, csrf_token) {
            $.ajax({
                type: 'POST',
                url: '{% url 'chat_get_message' %}',
                data: {
                    chat_id: chat_id
                },
                success: function (response) {
                    $("#messageList").html('');
                    $("#chatMessageTitle").html('');
                    console.log('***', response.chat);
                    $.tmpl(tmplChatMessageTitle, response.chat).appendTo($("#chatMessageTitle"));
                    $.each(response.messages, function( index, value ) {
                        if ('{{user}}' === value.user) {
                            value.odd =  "odd bounceInRight animated";
                            $.tmpl(tmplMsgLi, value).appendTo("#messageList");
                        }else {
                            value.odd =  "bounceInLeft animated";
                            $.tmpl(tmplMsgLi, value).appendTo("#messageList");
                        }

                    });
                    var bottomCoord = $('#messageList')[0].scrollHeight;
                    $('#messageList').slimScroll({scrollTo: bottomCoord});

                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                dataType: 'json'
            })
        };

        socket = null;

        var setLastMessage = function (chat_id) {
            $("[chat-id=" + chat_id + "]").animate({scrollTop: 9999}, 1000);
        };
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var setBoxMessage = function (box_id, chat_label, chat_id) {
            chatReadMessage(chat_id, '{{ csrf_token }}');
            setLastMessage(chat_id);
            $('.conversation').hide();
            var elBox = $('#' + box_id);
            elBox.show();
            elBox.find('#comment').val(null);
            socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/?label=" + chat_label);
            socket.onopen = function (data) {
                socket.send(data);
            };
            socket.onmessage = function (e) {
                var data = JSON.parse(e.data);
                setLastMessage(chat_id);
                var messagePosition = 'receiver ';
                if ('{{user}}' == data.user) {
                    messagePosition = 'sender';
                }
                var chatContent = $('[chat-id=' + chat_id + ']').find('.message-body').last();
                var blockMessage = "" +
                    "<div class='col-sm-12 message-main-" + messagePosition + "'>" +
                    "<div class='" + messagePosition + "'>" +
                    "<strong class='pull-left primary-font'>" + data.user + "</strong>" +
                    "<div class='message-text'>" + data.text + "</div>" +
                    "<span class='message-time pull-right'>" + formatDate(data.message_create_date) + "</span>" +
                    "</div>" +
                    "</div>";
                chatContent.append(blockMessage);
            };

{#            sendMessage = function () {#}
{#                setLastMessage();#}
{#                var el = $("#" + box_id).find('#comment');#}
{#                if (el.val().trim()) {#}
{#                    var data = JSON.stringify({#}
{#                        'text': el.val(),#}
{#                        'chat': chat_id,#}
{#                        'label': chat_label#}
{#                    });#}
{#                    socket.onopen(data);#}
{#                    el.val(null);#}
{#                }else {#}
{#                    el.val(null)#}
{#                }#}
{#            };#}

            $.fn.enterKey = function (fnc) {
                return this.each(function () {
                    $(this).keypress(function (ev) {
                        var keycode = (ev.keyCode ? ev.keyCode : ev.which);
                        if (keycode == '13') {
                            fnc.call(this, ev);
                        }
                    })
                })
            };
            elBox.find('#comment').enterKey(function () {
                sendMessage();
            })
        }

    </script>
{% endblock %}
